\documentclass[12pt]{article}
\author{Alex Ho}
\title{FYS4150 - Computational Physics \\ Project 5}
\usepackage{listings}
\usepackage{graphicx}
\usepackage{verbatim}
\usepackage{amsmath}
\usepackage{float}
\usepackage[utf8]{inputenc}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{placeins}
\usepackage{parskip}
\setlength\parskip{\baselineskip}
\setlength\parindent{0pt}

\lstset{
language=Python,
basicstyle=\ttfamily,
otherkeywords={self},             
keywordstyle=\ttfamily\color{blue!90!black},
keywords=[2]{True,False},
keywordstyle={[2]\ttfamily\color{blue!90!black}},
emph={MyClass,__init__},          
emphstyle=\ttfamily\color{red!80!black},    
stringstyle=\color{blue!90!black},
showstringspaces=false,
commentstyle=\color{blue!90!black},
breaklines=true,
tabsize=3,
moredelim=**[is][\color{blue}]{@}{@}
}
\begin{document}
\maketitle
\begin{abstract}
\end{abstract}
\newpage
\tableofcontents
\newpage
\section{Introduction} \label{section:intro}

All relevant files used in this project can be found in the this GitHub page:
\url{https://github.com/AHo94/FYS3150_Projects/tree/master/Project5}
\section{Method} \label{section:method}
\subsection{Analytical form for the trial wave function and local energy}
For this project, we will use natural units. That is $\hbar = c = e = m_e = 1$.
We will consider two electrons in a quantum dot with a frequency $\hbar \omega = 1$. The Hamiltonian for these two electrons is
\begin{align*}
H_0 = -\frac{1}{2}(\nabla_1^2 + \nabla_2^2) + \frac{1}{2}\omega^2(r_1^2 + r_2^2)
\end{align*}
The wave function for one electron in a harmonic oscillator potential is
\begin{align*}
\phi_{n_x, n_y, n_z}(x,y,z) = \frac{A}{2}H_{n_x}(\sqrt{\omega} x)H_{n_y}(\sqrt{\omega}y)H_{n_z}(\sqrt{\omega}z)e^{-\frac{\omega}{2}(x^2+y^2+z^2)}
\end{align*}
Where $H_{n_x}$ are Hermite polynomials and $A$ is a normalization constant. $n_x, n_y$ and $n_z$ are some quantum numbers. When the Hamiltonian is acted on this wave function, we obtain the energy. That is
\begin{align*}
H_0\phi_{n_x, n_y, n_z} &= \epsilon_{n_x, n_y, n_z}\phi_{n_x, n_y, n_z}
\end{align*}
with the energy given as
\begin{align*}
\epsilon_{n_x, n_y, n_z} &= \omega\left(n_x + n_y + n_z + \frac{3}{2} \right)
\end{align*}
For the ground state, $n_x = n_y = n_z = 0$, the energy of the single electron is
\begin{align*}
\epsilon_{0,0,0} = \frac{3}{2}\omega
\end{align*}
Let us now consider two electrons, so we have $\phi_{n_x, n_y, n_z}^1$ and $\phi_{n_x, n_y, n_z}^2$ (not squared!). Acting the Hamiltonian on both these wave functions gives
\begin{align*}
H_0(\phi_{n_x, n_y, n_z}^1 + \phi_{n_x, n_y, n_z}^2) &= \epsilon_{n_x, n_y, n_z}^1\phi_{n_x, n_y, n_z}^1 + \epsilon_{n_x, n_y, n_z}^2\phi_{n_x, n_y, n_z}^2 
\end{align*}
The total energy for these two electrons, when we consider the ground state, is then
\begin{align*}
\epsilon_{0,0,0}^{\text{tot}} &= \epsilon_{0,0,0}^1 + \epsilon_{0,0,0}^2 \\
&= \omega\left(\frac{3}{2} \right) + \omega\left(\frac{3}{2} \right)\\
&= 3\omega
\end{align*}

%% Add stuff for unperturbed case

We will now consider two trial functions given as
\begin{align*}
\psi_{T_1} &= C \exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right) \\
\psi_{T_2} &= C \exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right)\exp\left(\frac{r_{12}}{2(1+\beta r_{12})}\right)
\end{align*}
where $r_{12} = \sqrt{r_1 - r_2}$ and $\alpha$ and $\beta$ are variational parameters. The second exponential in the $\psi_{T_2}$ is known as the Jastrow factor, which is there because it gives the lowest possible energy for the system, while reducing the amount of variational parameters.

Let us find the energy of the first trial function. First, we should rewrite the Hamiltonian in spherical coordinates. Our system does not depend on the radial coordinates, so the $\nabla$ operator, for electron $i$ in spherical coordinates, becomes
\begin{align*}
\nabla^2_i = -\frac{1}{2} \frac{d^2}{dr^2_i} - \frac{1}{r_i}\frac{d}{dr_i}
\end{align*}
By acting the Hamiltonian on $\psi_{T_1}$, we get
\begin{align*}
H_0\psi_{T_1} = \left(-\frac{d^2}{dr^2_1} - \frac{1}{r_1}\frac{d}{dr_1} -\frac{d^2}{dr^2_2} - \frac{1}{r_2}\frac{d}{dr_2} + \frac{1}{2}\omega(r_1^2+r_2^2)\right)\psi_{T_1}
\end{align*}
There will be a lot of derivatives to keep track of here, so I will take this step by step. Let us first differentiate with respect to $r_1$ first. The first derivative is
\begin{align*}
\frac{d}{dr_1}\exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right) &= \left( -\alpha \omega r_1 \right)\exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right) \\
&= -\alpha \omega r_1 \psi_{T_1}
\end{align*}
The second derivative then becomes
\begin{align*}
\frac{d^2}{dr_1^2}\exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right) &= \frac{d}{dr_1}\left[-\alpha \omega r_1 \exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right)\right]\\
&= (-\alpha \omega + \alpha^2 \omega^2 r_1^2)\exp\left(-\frac{\alpha \omega}{2}(r^2_1 + r^2_2)\right) \\
&= (\alpha^2 \omega^2 r_1^2 - \alpha \omega)\psi_{T_1}
\end{align*}
In short, the kinetic term is
\begin{align}
\nabla_1^2 \psi_{T_1} =-\frac{1}{2}(\alpha^2\omega^2r_1^2 -3 \alpha \omega)\psi_{T_1}
\label{eq:Kinetic_psi1}
\end{align}
I will skip the calculation for the derivative with respect to $r_2$, but the results are
\begin{align*}
\frac{d}{dr_2}\psi_{T_1} &=  -\alpha \omega r_2 \psi_{T_1} \\
\frac{d^2}{dr_2^2}\psi_{T_1} &= (\alpha^2 \omega^2 r_2^2 - \alpha \omega)\psi_{T_1}
\end{align*}
which gives
\begin{align*}
\nabla_1^2 \psi_{T_1} =-\frac{1}{2}(\alpha^2\omega^2r_2^2 -3 \alpha \omega)\psi_{T_1}
\end{align*}
The local energy, for this trial function, is then
\begin{align}
E_{L_1} &= -\frac{1}{2} (\alpha^2 \omega^2 r_1^2 - 3\alpha \omega)  - \frac{1}{2} (\alpha^2 \omega^2 r_2^2 - 3\alpha \omega) + \frac{1}{2}\omega^2(r_1^2 + r_2^2) \nonumber \\
&= 3 \alpha \omega  - \frac{1}{2}\alpha^2 \omega^2 (r_1^2 + r_2^2) + \frac{1}{2}\omega(r_1^2 + r_2^2) \nonumber \\
&= 3\alpha \omega + \frac{1}{2}(\omega^2 - \alpha^2 \omega^2)(r_1^2 + r_2^2) \nonumber \\
&= 3 \alpha \omega +  \frac{1}{2}\omega^2(1-\alpha^2)(r_1^2 + r_2^2)
\label{eq:Energy_T1}
\end{align}
which is exactly what we wanted to show. We will skip the derivation of the analytical local energy for the second trial wave function. If we add Coulomb interaction, the Hamiltonian now becomes
\begin{align*}
H_0 = \displaystyle \sum_{i=1}^N\left(-\frac{1}{2}\nabla_i^2 + \frac{1}{2}\omega^2r_i^2 \right) + \sum_{i<j}\frac{1}{r_{ij}}
\end{align*}
and the local energy for the first trial wave function is then
\begin{align}
E_{L1} = 3 \alpha \omega +  \frac{1}{2}\omega^2(1-\alpha^2)(r_1^2 + r_2^2) + \frac{1}{r_{12}}
\label{eq:Energy_T1_Coulomb}
\end{align}
where $r_{12}= |\mathbf{r}_1 - \mathbf{r}_2|$. The analytical expression for the second trial wave function, with Coulomb interaction, is then
\begin{align}
E_{L2} = E_{L1} + \frac{1}{2(1+\beta r_{12})^2}\left[\alpha \omega r_{12} - \frac{1}{2(1+\beta r_{12})} - \frac{2}{r_{12}} + \frac{2\beta}{1+\beta r_{12}} \right]
\label{eq:Energy_T2_Coulomb}
\end{align}
with $E_{L1}$ given in equation \ref{eq:Energy_T1_Coulomb}.

\subsection{The Metropolis Algorithm}
We will once again, like in project 4, use the Metropolis algorithm to solve our quantum mechanical system. The algorithm is as follows: for every Monte Carlo cycle we 
\begin{itemize}
\item \textbf{1)} Start the electrons at an arbitrary position. We let the electron start at the position $x,y,z \in [-1,1]$, which we get from a normal distribution.

\item \textbf{2)} Give the electrons a new position determined by $\mathbf{R}' = \mathbf{R} + \delta\times r$, where $\mathbf{R} = (\mathbf{r}_1, \mathbf{r}_2, ..., \mathbf{r}_N)$, $r$ is a random number generated from a normal distribution $r\in [-1,1]$ and $\delta$ is a small step length. For this project we will consider $N=2$ electrons.

\item \textbf{3)} Calculate $w = P(\mathbf{R}')/P(\mathbf{R}) = |\Psi(\mathbf{R}')|^2/|\Psi(\mathbf{R})|^2$, where $\Psi$ is the wave function we will consider (i.e the trial wave functions $\psi_{T1}$ and $\psi_{T2}$ mentioned previously). Pick a random number $s\in [0,1]$, also given from a normal distribution function. We now have to consider these two cases

\item \textbf{Case 1}: If $s <= w$, we accept this new position change and use the calculated $\mathbf{R}'$ to calculate the local energy. The system has now reached a lower energy state.

\item \textbf{Case 2}: If $s > w$, we do not accept this new position and use the old position $\mathbf{R}$ to calculate the local energy.

\item \textbf{4)} Use the new or old position (depending on whatever case above hits) to calculate the local energy $E_L = \frac{1}{\Psi} H_0\Psi$. 
\end{itemize}
By calculating the fraction $|\Psi(\mathbf{R}')|^2/|\Psi(\mathbf{R})|^2$, we eliminate the requirement to compute the integral given in
\begin{align*}
P(\mathbf{R}) = \frac{|\Psi(\mathbf{R})|^2}{\int |\Psi(\mathbf{R})|^2 d\mathbf{R}}
\end{align*}
which is similar to what we did in project 4. In project 4, by calculating $r<= e^{-\beta \delta E}$, we could skip the calculation of the partition function $Z$. 

Once again, by running this for $N_{mc}$ Monte Carlo cycles, we find the energy expectation value as
\begin{align*}
\langle E \rangle = \displaystyle \frac{1}{N_{mc}}\sum_i E_i
\end{align*}
where $E_i$ is all the energy samples calculated from the Metropolis algorithm. One can also find the expectation value of the mean distance at the energy minimum $r_{12} = |\mathbf{r}_1 - \mathbf{r}_2|$ in the same way.

\subsection{Algorithm that determines the step length}
We would like to find an algorithm that, for a given value of $\alpha$, uses an optimal value of the step length $\delta$. This should ideally result to roughly 50\% accepted moves in the metropolis algorithm. One can run the program multiple times to determine the step length. However, one can also find an analytical solution, which would automatize the optimal step length.

Since we are looking at accepted moves, we will take a look at the equation
\begin{align*}
s = \frac{|\Psi(\mathbf{R'})|^2}{|\Psi(\mathbf{R})|^2}
\end{align*}
which was used to determine whether we accept a move or not in the Metropolis algorithm. We let $s = 0.5$, as we want roughly 50\% accepted moves. We then plug in the first trial wave function to determine an optimal $\delta$ for a given $\alpha$, which gives
\begin{align*}
0.5 &= \frac{\exp\left[-\alpha \omega \big((r_1+r\delta)^2 + (r_2 + r\delta)^2\big)\right]}{\exp\left[-\alpha \omega(r_1^2+r_2^2) \right]} \\
&= \frac{\exp\left[-\alpha \omega(r_1^2 + r_2^2 + 2r_1r\delta + 2r_2r\delta + 2(r\delta)^2)\right]}{\exp\left[-\alpha \omega(r_1^2+r_2^2) \right]}\\
&= \exp\left[-2\alpha\omega r(r_1\delta + r_2\delta + r\delta^2) \right]
\end{align*}
Make sure not to confuse $r$ and $r_1, r_2$, as $r \in [-1,1]$ is given by the random distribution. Taking the logarithm on both sides gives
\begin{align*}
\ln(0.5) &= -2\alpha\omega r\left(\delta(r_1+r_2) + r\delta^2\right) \\
\implies & r\delta^2 + \delta(r_1 + r_2) + \frac{\ln(0.5)}{2\alpha \omega r} = 0
\end{align*}
This is a second order equation for $\delta$. We require that $\delta$ is always positive, so when we solve this equation for $\delta$, we will have to only consider the positive part. Doing this results to
\begin{align}
\delta = \frac{1}{2r}\left(-(r_1 + r_2) + \sqrt{(r_1+r_2)^2 - \frac{2\ln(0.5)}{\alpha \omega}}\right)
\label{eq:step_length_algo}
\end{align}
Implementing this in the program \emph{should} result to roughly 50\% of the configurations being accepted. However, we will see that it is not always the case, but the number of accepted configurations will be relatively close to 50\%.
\section{Implementation} \label{section:implement}
Like in the previous projects, I will do all the calculations in C++ and plot the results in Python.

For this project, I will utilize the \texttt{vec3} class that we developed in project 3. This class will make it easier to keep track of all the components contained within the radius variable $\mathbf{r} = (x, y, z)$, as it contains methods to do certain vector calculations, e.g finding vector length and vector addition. 
\subsubsection*{Testing the Metropolis algorithm}
Before we proceed with the results, we should check if the Metropolis algorithm works as it should. When calculating the local energy, we should use a numerical approach to calculate the kinetic term $\nabla^2\psi$. However, we already have the analytical expression of the local energy $E_{L1}$, given in equation \ref{eq:Energy_T1}. From that, we also know which terms contributes to the kinetic energy. In fact, the kinetic energy is given in equation \ref{eq:Kinetic_psi1}, which we can use to test the Metropolis algorithm.

By implementing this term as its own function \texttt{LaplaceAnalytic}, we run the program with the analytical kinetic energy. Using $10^5$ Monte Carlo cycles, $\alpha = 1$, $\omega = 1$ and no Coulomb interaction, the result is:
\begin{lstlisting}
@Monte Carlo cycles = 100000
Energy = 3
Variance = 0
Accepted configs = 55274@
\end{lstlisting}
So the numerical energy, using the analytical expression of the kinetic energy, is exactly 3! The variance is exactly zero as well, which is what we would expect from this test. Also note the number of accepted configurations. The algorithm for an optimal step length, given in equation \ref{eq:step_length_algo}, gives roughly 50\% accepted configurations. 
\section{Results}\label{section:results}

\FloatBarrier
\section{Conclusion}\label{section:conclusion}

\FloatBarrier
\begin{thebibliography}{1}
    \bibitem{cpyhsics} M. Hjorth-Jensen, \emph{Computational Physics}, 2015, 551 pages
\end{thebibliography}
\end{document}